<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ STT + ë²ˆì—­ + ìš”ì•½ ë·°ì–´ (Prototype)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #050816;
      --panel-soft: #020617cc;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border: #1f2937;
      --error: #f97373;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 60%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      padding: 20px 16px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin: 2px 0 0;
      font-size: 0.85rem;
      color: var(--text-sub);
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.78rem;
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4b5563;
    }

    .status-dot.live {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .card {
      background: radial-gradient(circle at top left, #0b1120 0, #020617 55%);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 14px 14px 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
    }

    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .controls-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .controls-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid var(--border);
      transition: background 0.12s ease, transform 0.08s ease,
        box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border-color: transparent;
      color: white;
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.5);
    }

    .btn.primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(56, 189, 248, 0.6);
      filter: brightness(1.04);
    }

    .btn.secondary:hover:not(:disabled) {
      background: rgba(31, 41, 55, 0.9);
      border-color: #4b5563;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .tag {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #bae6fd;
      border: 1px solid rgba(56, 189, 248, 0.4);
    }

    .status-text {
      font-size: 0.8rem;
      color: var(--text-sub);
      min-height: 18px;
    }

    .status-text.error {
      color: var(--error);
    }

    .status-text.success {
      color: var(--success);
    }

    .columns {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 8px;
    }

    .col {
      background: var(--panel-soft);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
      max-height: 520px;
    }

    .col-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .col-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-main);
    }

    .col-sub {
      font-size: 0.7rem;
      color: var(--text-sub);
    }

    .scroll-box {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.85rem;
      line-height: 1.5;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .scroll-box::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-box::-webkit-scrollbar-track {
      background: transparent;
    }
    .scroll-box::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 999px;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .badge-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .record-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ef4444;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.9);
      animation: pulse 1.1s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.4);
        opacity: 0.3;
      }
      100% {
        transform: scale(1);
        opacity: 0.8;
      }
    }

    .spinner {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.35);
      border-top-color: white;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 960px) {
      .columns {
        grid-template-columns: 1fr;
      }
      .col {
        min-height: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ì‹¤ì‹œê°„ STT Â· ë²ˆì—­ Â· ìš”ì•½ ë·°ì–´</h1>
        <p class="subtitle">
          ë¸Œë¼ìš°ì €ì—ì„œ ì‹œìŠ¤í…œ ì‚¬ìš´ë“œë¥¼ ìº¡ì²˜í•˜ê³ , ë°±ì—”ë“œì—ì„œ Whisper STT + ë²ˆì—­ AI + ìš”ì•½ AIë¡œ ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        </p>
      </div>
      <div class="pill">
        <span id="live-dot" class="status-dot"></span>
        <span id="live-label">ëŒ€ê¸° ì¤‘</span>
      </div>
    </header>

    <div class="card">
      <div class="control-bar">
        <div class="controls-left">
          <button id="start-btn" class="btn primary">
            <span class="btn-icon">â–¶</span>
            <span>ë²ˆì—­ ì‹œì‘</span>
          </button>
          <button id="stop-btn" class="btn secondary" disabled>
            <span class="btn-icon">â– </span>
            <span>ì¤‘ì§€</span>
          </button>
          <span class="tag">System Audio Capture + WebSocket</span>
        </div>
        <div class="controls-right">
          <span class="badge-row">
            <span class="tag">Whisper STT (transcribe)</span>
            <span class="tag">Custom Translator (ko+en â†’ en)</span>
            <span class="tag">Summarizer</span>
          </span>
        </div>
      </div>

      <div id="status" class="status-text"></div>

      <div class="columns">
        <div class="col">
          <div class="col-header">
            <div>
              <div class="col-title">ì›ë¬¸ (STT Transcript)</div>
              <div class="col-sub">í•œêµ­ì–´ + ì˜ì–´ í˜¼í•© ê·¸ëŒ€ë¡œ</div>
            </div>
          </div>
          <div id="raw-box" class="scroll-box"></div>
        </div>

        <div class="col">
          <div class="col-header">
            <div>
              <div class="col-title">ë²ˆì—­ (English)</div>
              <div class="col-sub">Custom Translation Model</div>
            </div>
          </div>
          <div id="translation-box" class="scroll-box"></div>
        </div>

        <div class="col">
          <div class="col-header">
            <div>
              <div class="col-title">ìš”ì•½ (Summary)</div>
              <div class="col-sub">High-level English Summary</div>
            </div>
          </div>
          <div id="summary-box" class="scroll-box"></div>
        </div>
      </div>

      <div class="hint">
        ğŸ’¡ <strong>ë™ì‘ ë°©ì‹ (í”„ëŸ°íŠ¸ ê¸°ì¤€)</strong><br />
        1) <strong>ë²ˆì—­ ì‹œì‘</strong> ë²„íŠ¼ â†’ <code>getDisplayMedia({ video: true, audio: true })</code> ë¡œ
        ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.<br />
        2) <code>MediaRecorder</code> ë¡œ ì˜¤ë””ì˜¤ chunkë¥¼ ë…¹ìŒí•´ì„œ
        <code>WebSocket</code> (<code>ws://localhost:8000/ws/transcribe</code>)ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.<br />
        3) ë°±ì—”ë“œëŠ” ê° chunkë¥¼ <code>Whisper STT â†’ ë²ˆì—­ AI â†’ ìš”ì•½ AI</code>ë¡œ ì²˜ë¦¬ í›„
        <code>{"raw", "translation", "summary"}</code> JSONì„ ë‹¤ì‹œ WebSocketìœ¼ë¡œ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.<br />
        4) ì´ í˜ì´ì§€ëŠ” ê·¸ JSONì„ ë°›ì•„ì„œ ì™¼ìª½/ê°€ìš´ë°/ì˜¤ë¥¸ìª½ ì¹¼ëŸ¼ì—
        <strong>íƒ€ì´í•‘ë˜ëŠ” ëŠë‚Œ</strong>ìœ¼ë¡œ ìŒ“ì•„ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script>
    // ===== ì„¤ì • ì˜ì—­ =====
    // WebSocket ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ (ë°±ì—”ë“œ êµ¬í˜„ì— ë§ê²Œ ë³€ê²½)
    const WS_URL = "ws://localhost:8000/ws/transcribe";

    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusEl = document.getElementById("status");
    const rawBox = document.getElementById("raw-box");
    const translationBox = document.getElementById("translation-box");
    const summaryBox = document.getElementById("summary-box");
    const liveDot = document.getElementById("live-dot");
    const liveLabel = document.getElementById("live-label");

    let mediaStream = null;
    let mediaRecorder = null;
    let ws = null;
    let isRecording = false;

    // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ (ê°„ë‹¨ ë²„ì „)
    function appendWithTyping(element, text, speed = 12) {
      if (!text) return;
      const span = document.createElement("span");
      element.appendChild(span);

      let i = 0;
      function step() {
        if (i <= text.length) {
          span.textContent = text.slice(0, i);
          element.scrollTop = element.scrollHeight;
          i++;
          setTimeout(step, speed);
        }
      }
      step();

      // ì¤„ë°”ê¿ˆ ì¶”ê°€
      const br = document.createElement("br");
      element.appendChild(br);
    }

    function setStatus(msg, type = "") {
      statusEl.textContent = msg || "";
      statusEl.classList.remove("error", "success");
      if (type === "error") statusEl.classList.add("error");
      if (type === "success") statusEl.classList.add("success");
    }

    function setLiveState(live) {
      if (live) {
        liveDot.classList.add("live");
        liveLabel.textContent = "ì‹¤ì‹œê°„ ì²˜ë¦¬ ì¤‘";
      } else {
        liveDot.classList.remove("live");
        liveLabel.textContent = "ëŒ€ê¸° ì¤‘";
      }
    }

    async function startCapture() {
      if (isRecording) return;

      try {
        // 1) ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜ (ë¸Œë¼ìš°ì €/OSì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        //    - Chrome ê¸°ì¤€: getDisplayMedia(audio: true) ë¡œ íƒ­/í™”ë©´ ì˜¤ë””ì˜¤ ìº¡ì²˜ ê°€ëŠ¥
        mediaStream = await navigator.mediaDevices.getDisplayMedia({
          video: true,  // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” audioë§Œ í—ˆìš©í•˜ì§€ ì•Šì•„ì„œ videoë„ ë„£ì–´ë‘  (ì˜ìƒì€ ì‚¬ìš© ì•ˆ í•¨)
          audio: {
            echoCancellation: false,
            noiseSuppression: false
          }
        });

        // 2) WebSocket ì—°ê²°
        ws = new WebSocket(WS_URL);

        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          setStatus("WebSocket ì—°ê²° ì™„ë£Œ. ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.", "success");

          // 3) MediaRecorder ì„¤ì •
          let mimeType = "";
          if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
            mimeType = "audio/webm;codecs=opus";
          } else if (MediaRecorder.isTypeSupported("audio/webm")) {
            mimeType = "audio/webm";
          } else {
            // ë¸Œë¼ìš°ì € ì§€ì› ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
            mimeType = "";
          }

          try {
            mediaRecorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);
          } catch (err) {
            console.error("MediaRecorder ìƒì„± ì‹¤íŒ¨:", err);
            setStatus("MediaRecorderë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €/ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
            ws.close();
            mediaStream.getTracks().forEach(t => t.stop());
            return;
          }

          mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
              ws.send(event.data);  // ì˜¤ë””ì˜¤ chunkë¥¼ ê·¸ëŒ€ë¡œ ì „ì†¡ (ë°±ì—”ë“œì—ì„œ webm/opus â†’ wav/mp3 ë³€í™˜)
            }
          };

          mediaRecorder.onerror = (event) => {
            console.error("MediaRecorder error:", event.error);
            setStatus("ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + event.error.message, "error");
          };

          mediaRecorder.start(800); // 800ms ë‹¨ìœ„ë¡œ chunk ì „ì†¡ (ì›í•˜ë©´ 500~2000ms ì‚¬ì´ë¡œ ì¡°ì ˆ)

          isRecording = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          setLiveState(true);
          setStatus("ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜ & ì‹¤ì‹œê°„ ì „ì†¡ ì¤‘...", "");
        };

        ws.onmessage = (event) => {
          let data = JSON.parse(event.data);
        
          // ë°°ì—´ í˜•íƒœë¼ë©´ ìˆœíšŒ
          if (Array.isArray(data)) {
              data.forEach(item => {
                  if (!item.translation) return;
        
                  let ko = item.translation.ko || "";
                  let en = item.translation.en || "";
                  let summary = item.summary || "";  // summaryê°€ ìˆë‹¤ë©´
        
                  // ì™¼ìª½ ì¹¼ëŸ¼: í•œêµ­ì–´
                  if (ko) appendWithTyping(rawBox, ko + "\n");
        
                  // ê°€ìš´ë° ì¹¼ëŸ¼: ì˜ì–´
                  if (en) appendWithTyping(translationBox, en + "\n");
        
                  // ì˜¤ë¥¸ìª½ ì¹¼ëŸ¼: ìš”ì•½ (ì—†ì„ ìˆ˜ë„ ìˆìŒ)
                  if (summary) appendWithTyping(summaryBox, summary + "\n");
              });
          } 
          // ë‹¨ì¼ ì˜¤ë¸Œì íŠ¸ì¼ ê²½ìš° ëŒ€ë¹„
          else {
              const ko = data.translation?.ko || "";
              const en = data.translation?.en || "";
              const summary = data.summary || "";
        
              if (ko) appendWithTyping(rawBox, ko + "\n");
              if (en) appendWithTyping(translationBox, en + "\n");
              if (summary) appendWithTyping(summaryBox, summary + "\n");
          }
        };


        ws.onerror = (event) => {
          console.error("WebSocket error:", event);
          setStatus("WebSocket ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
        };

        ws.onclose = () => {
          if (isRecording) {
            stopCapture(true);
          }
        };

      } catch (err) {
        console.error("ìº¡ì²˜ ì‹œì‘ ì‹¤íŒ¨:", err);
        if (err.name === "NotAllowedError") {
          setStatus("í™”ë©´/ì˜¤ë””ì˜¤ ìº¡ì²˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
        } else {
          setStatus("ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message, "error");
        }
        setLiveState(false);
      }
    }

    function stopCapture(fromWsClose = false) {
      if (!isRecording) return;

      // MediaRecorder ì¤‘ì§€
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }

      // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ stop
      if (mediaStream) {
        mediaStream.getTracks().forEach((track) => track.stop());
        mediaStream = null;
      }

      // WebSocket ë‹«ê¸° (ì´ë¯¸ ë‹«íŒ ê²½ìš°ëŠ” ë¬´ì‹œ)
      if (ws && ws.readyState === WebSocket.OPEN && !fromWsClose) {
        ws.close();
      }
      ws = null;

      isRecording = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setLiveState(false);
      setStatus("ìº¡ì²˜ ë° ì „ì†¡ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
    }

    startBtn.addEventListener("click", () => {
      // ì¶œë ¥ì°½ ë¦¬ì…‹
      rawBox.textContent = "";
      translationBox.textContent = "";
      summaryBox.textContent = "";
      setStatus("ê¶Œí•œ ìš”ì²­ ì¤‘...", "");
      startCapture();
    });

    stopBtn.addEventListener("click", () => {
      stopCapture(false);
    });

    window.addEventListener("beforeunload", () => {
      stopCapture(false);
    });
  </script>
</body>
</html>
